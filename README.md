# EdgeOS OpenVPN Status Feature Wizard
This adds an OpenVPN Status Feature Wizard to your EdgeOS router in the Wizards tab. It simply parses and displays the `openvpn-status.log` file generated by OpenVPN.

**DISCLAIMER:** This is a personal utility I made for myself and comes with no guarantees that it will work on every (or any) EdgeMAX router. I did not have any documentation or support to build this Wizard. I simply found where the wizards were stored and reverse engineered the "VPN Status" wizard that came with the router to build this one. This has only been tested on my EdgeRouter X running EdgeOS v1.10.11, and is NOT fully tested or robust. I would NOT consider it Production Ready. Feel free to improve upon this to make it more robust, use better parsing methods, detect & handle more errors and edge cases, etc. But ultimately, use it at your own risk.

## Background

When I noticed the `+` button beside Features in the Wizards area, I realized the intention was for the community to build their own wizards for the router. Of course my first instinct was to look for a repository of community (or official) wizards I could add. All I could find however were users asking if something like this exists in the Ubiquiti support forums. Apparently there is a beta testing program where some users have gotten acccess to preliminary docs / info on this, but it's not public yet. 

### Reverse-engineering how they work ###
The router runs on Debian, this is a web interface. My first instinct was to see if anything lived in the `/var/www` folder, and viola, inside of it was a folder called `wizard` that contained `status` and `feature` sub-folders. Gotcha.

Diving into the `VPN_status` folder, I was surprised to see how simple the structure of a Feature Wizard was. The system is _very much_ designed around convention over configuration. You simply put things where they should be and name them a certain way, and the magic fairies will make the rest work. Systems like this can be easy and quick to set up, but can also be frustrating & limiting if you don't know how the system really works or what the available options are.

### Folder/File Structure ###
Each wizard lives in its own folder under `/var/www/wizard/feature`

The folder name of the wizard becomes its title in the menu. Underscores are converted to spaces.

Each wizard folder has two files in it:
```
wizard-run    # bash script to process command
wizard.html   # html template 
```
_Note: In wizards that take input, there is also a `validator.json` file with validation rules for the input. I won't cover this here as my wizard does not take input._

The `wizard-run` file is nothing more than a bash script that takes a command and some input, and replies with JSON. Consider it a bash-driven API for the wizard.

The `wizard.html` file is the view/template for the wizard. It takes input and displays output.

### Basic Operation ###

#### wizard-run ####

`wizard-run` takes two command-line input parameters:

- `$1` is the command/action the wizard should perform. This is a string, and the first command a wizard gets from EdgeOS seems to be `load`, which asks it to load any initial information required to be displayed.
- `$2` is any info submitted from the wizard by the user (via form submission). This is not used during the initial `load` command. Only wizards that take input use this. Since mine doesn't and  We won't and I haven't played with this, so I won't discuss it here. (But looking at other wizards, and given the pattern across EdgeOS, I believe this parameter will receive a JSON object representing the form submission, which you'd use `jq` to parse. See the `DNS_host_names` wizard for examples.)

Beyond this, it's nothing more than a regular bash script. You can run any available bash commands on the system, use tools like `sed`, `grep`, `awk`, etc. You can also use some API functions exposed via the command-line by EdgeOS / Vyatta. Do whatever you want here, and then output the response via JSON.

The script must then return a JSON object, which seems to have this basic format:

```
{
    success: 1 | 0,
    data: {
       key: "value",
       key2: [ { name: "name", value: "value" } ],    
    },
    readonly: 1 | 0
}
```
`success` should be `1` to indicate success of the query, or `0` for failure.
`data` is an object with named properties. The names of the properties are used to bind and display data in `wizard.html`
`readonly` seems to indicate whether the data returned should be rendered as read-only or not. Our script always returns `1` as it is read-only. See the `wizard.html` info below for more details.

#### wizard.html ####
This is the display template for the interface. I don't know a lot about how EdgeOS is built (I literally bought my EdgeRouter X the day before writing this and created the wizard that evening. So I'm new to all of this), but I would venture to guess this interface utilizes existing code/conventions used across many other EdgeOS screens. 

It seems to employ a rudimentary Javascript data-binding system, where a JSON object is used to automatically populate/manipulate the HTML in the template. The HTML must be named/structure a certain way for this to work. Think of it as a lightweight / custom-baked system akin to Vue/React. You'll note there's no JavaScript in this file or in any of the Wizard folders. The JavaScript that runs this is elsewhere, and I'm guessing it's more core to EdgeOS as a whole, so it's not meant to be changed. This system almost feels like the developers of EdgeOS found a way to hack their own system to allow third party plugins to be developed without creating a massive/complex API and codebase just for it. Of course, I could be completely wrong about all of this. Just making guesses based on the patterns.

***TODO: Finish wizard.html write-up...***

## Configuring OpenVPN
OpenVPN must be configured to generate a status log using the `status-log` option.

1. For simplicity, generate the log in the home folder of your router admin user.
2. If your admin user is not `ubnt`, change the path of the home folder accordingly.
3. Specify an absolute path to the log so you can ensure it's placed where you expect it to be.

```
configure
set interfaces openvpn vtun0 openvpn-option "--status-log=/home/ubnt/openvpn-status.log"
commit;save
exit
```

The next step is to make this file readable by your admin user. This will not really affect the script, it just makes it easier to manually view this file if you login to the CLI, and for testing/development. 

```
sudo su
chown siteadmin:users openvpn-status.log
chmod 660 openvpn-status.log
exit
```

## Installing the Wizard

The next step is to install the Wizard on the router. I the admin interface there is a `+` button beside the Feature wizards section, but I have not yet figured out what format it expects the files in (uploading the individual files or a ZIP file comes back with an error.) 

So for now, I simply copied the files to the router via SCP. The process is to copy the `OpenVPN_status` folder to the `/var/www/wizard/feature` folder on the router. First, you'll need to move it into your home folder, then change to the `root` user to move it to the final destination (since the web folders on the router are owned by `root`.)

First, you need to copy the `VPN_status` files to the router into your admin user's home folder"

```
scp -r VPN_status/ ubnt@192.168.x.x:~/
```

Then, login to your router via the CLI, change to root, and move the folder to the wizards area:

```
sudo su
mv VPN_status/ /var/www/wizard/feature/
chown -R root:root /var/www/wizard/feature/VPN_status
exit
```

This will move the wizard into the correct location on the server. 

## Updating the path to the log file in the Wizard

The script is setup by default to look for the status file in `/home/ubnt/openvpn-status.log`. If your admin user is different, or if you have the log file in a different location, you can edit the log file path by editing `wizard-run`:

```
sudo su
vi /var/www/wizard/feature/OpenVPN_status/wizard-run`
```

You'll find a bash variable `STATUS_LOG_PATH` at the top of the script, simply update that to the correct path and save the file.

```
STATUS_LOG_PATH="/home/username/status-filename.log"
```

## Verify it works

Login to your router and go to the Wizards area. You should see an OpenVPN status link under the Features area. Clicking on it should bring up a parsed version of the OpenVPN status log with two tables: the list of clients and the routing information below.

## Wishlist/TODOS

1. Error handling - what if the status file is not where the script thinks it is? What if no users are connected? OpenVPN not setup? etc.
2. Parsing - there's probably better ways to parse the file. I'm not a bash parsing expert.
3. Output - there might be cleaner ways to output this information. Might be limited by the Wizard conventions.
4. Date updated - also output the date last updated (for the file overall), found at the top of the status file.
